name: Backend pipeline (tests, build, deploy to EC2)

on:
  push:
    branches-ignore:
      - main

permissions:
  contents: read
  pull-requests: read

jobs:
  check_pr_open:
    runs-on: ubuntu-latest
    outputs:
      has_pr: ${{ steps.prcheck.outputs.has_pr }}
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check if branch has an open PR
        id: prcheck
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          OWNER: ${{ github.repository_owner }}
          BRANCH: ${{ github.ref_name }}
        run: |
          set -euo pipefail
          url="https://api.github.com/repos/${REPO}/pulls?state=open&head=${OWNER}:${BRANCH}"
          count=$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" -H "Accept: application/vnd.github+json" "${url}" | jq 'length')
          if [ "$count" -gt 0 ]; then
            echo "Open PR found for ${OWNER}:${BRANCH}"
            echo "has_pr=true" >> "$GITHUB_OUTPUT"
          else
            echo "No open PR for ${OWNER}:${BRANCH}. Skipping pipeline."
            echo "has_pr=false" >> "$GITHUB_OUTPUT"
          fi

  test_build_deploy:
    needs: check_pr_open
    if: needs.check_pr_open.outputs.has_pr == 'true'
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test -d testdb"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=10

    env:
      DATABASE_URL: postgresql://test:test@localhost:5432/testdb

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install deps (backend)
        working-directory: backend
        run: npm ci

      - name: Prisma generate
        working-directory: backend
        run: npm run prisma:generate

      - name: Apply migrations (CI)
        working-directory: backend
        run: npx prisma migrate deploy

      - name: Run tests
        working-directory: backend
        run: npm test

      - name: Build backend
        working-directory: backend
        run: npm run build

      - name: Package artifact
        run: |
          set -euo pipefail
          tar -czf backend-artifact.tar.gz \
            backend/dist \
            backend/package.json \
            backend/package-lock.json \
            backend/prisma

      - name: Install SSH key
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts

      - name: Copy artifact to EC2
        run: |
          set -euo pipefail
          scp -i ~/.ssh/id_rsa backend-artifact.tar.gz \
            "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ secrets.APP_DIR }}/backend-artifact.tar.gz"

      - name: Deploy on EC2 (install, migrate, restart)
        env:
          APP_DIR: ${{ secrets.APP_DIR }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          set -euo pipefail
          ssh -i ~/.ssh/id_rsa "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" << 'EOF'
            set -euo pipefail

            APP_DIR="${APP_DIR:-/home/ubuntu/app}"
            # Safety checks: avoid catastrophic deletion if APP_DIR is wrong
            if [ -z "$APP_DIR" ] || [ "$APP_DIR" = "/" ] || [ "$APP_DIR" = "/home" ] || [ "$APP_DIR" = "/home/ubuntu" ]; then
              echo "ERROR: APP_DIR is unsafe: '$APP_DIR'"
              exit 1
            fi

            mkdir -p "$APP_DIR/current"
            cd "$APP_DIR"

            rm -rf "$APP_DIR/current"/*
            tar -xzf backend-artifact.tar.gz -C "$APP_DIR/current"
            cd "$APP_DIR/current/backend"

            # Write runtime env (only what we need)
            if [ -z "${DATABASE_URL:-}" ]; then
              echo "ERROR: DATABASE_URL secret is not set"
              exit 1
            fi

            echo "DATABASE_URL=${DATABASE_URL}" > .env

            npm ci --omit=dev
            npm run prisma:generate
            npx prisma migrate deploy

            if pm2 describe backend >/dev/null 2>&1; then
              pm2 restart backend
            else
              pm2 start dist/index.js --name backend
            fi

            pm2 save
          EOF

